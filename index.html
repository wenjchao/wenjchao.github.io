import React, { useState, useEffect, useMemo } from 'react';
import { 
  FileText, 
  ClipboardList, 
  Activity, 
  BrainCircuit, 
  Plus, 
  X, 
  ChevronRight,
  Sparkles,
  Loader2
} from 'lucide-react';

/**
 * CONFIGURATION & API SERVICES
 * 易於擴展：修改此處即可更換 AI 模型或 API
 */
const AI_CONFIG = {
  model: 'gemini-2.5-flash-preview-09-2025',
  apiKey: '', // 執行環境會自動注入
};

// 模擬 API 呼叫 (未來可輕鬆換成真正的 Firebase 或 API)
const apiService = {
  async fetchAiAnalysis(patientState) {
    const prompt = `你是一位專業急診醫師。請根據以下病人資料提供 3 個可能的鑑別診斷(含機率%)及 3 個建議醫囑。
    資料: ${JSON.stringify(patientState)}
    請回傳 JSON 格式: { "dd": [{ "name": "疾病", "prob": 80, "reason": "原因" }], "orders": [{ "code": "代碼", "text": "醫囑" }] }`;

    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${AI_CONFIG.model}:generateContent?key=${AI_CONFIG.apiKey}`, {
      method: 'POST',
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { responseMimeType: "application/json" }
      })
    });
    const data = await res.json();
    return JSON.parse(data.candidates[0].content.parts[0].text);
  }
};

/**
 * UI COMPONENTS (可拆分為獨立檔案)
 */
const SectionCard = ({ title, icon: Icon, children, action, colorClass }) => (
  <div className="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-[450px] overflow-hidden">
    <div className={`p-3 border-b flex justify-between items-center ${colorClass}`}>
      <div className="flex items-center gap-2 font-bold text-slate-700">
        <Icon size={18} /> {title}
      </div>
      {action}
    </div>
    <div className="flex-1 overflow-y-auto p-4 space-y-3">
      {children}
    </div>
  </div>
);

export default function App() {
  // --- STATE MANAGEMENT ---
  const [notes, setNotes] = useState([
    { id: 1, type: 'Admission Note', title: 'Chest Pain Evaluation', content: '65y male, sudden onset chest pain...', date: '12/12' }
  ]);
  const [orders, setOrders] = useState([
    { id: 1, code: 'BLOOD001', text: 'CBC/DC', status: 'Done' }
  ]);
  const [results, setResults] = useState([
    { label: 'Hb', value: '13.5', unit: 'g/dL', normal: true },
    { label: 'Troponin-I', value: '0.5', unit: 'ng/mL', normal: false }
  ]);
  
  const [isNoteModalOpen, setNoteModalOpen] = useState(false);
  const [editingNote, setEditingNote] = useState(null);
  const [aiAnalysis, setAiAnalysis] = useState(null);
  const [isLoading, setIsLoading] = useState(false);

  // --- HANDLERS ---
  const handleRunAi = async () => {
    setIsLoading(true);
    try {
      const result = await apiService.fetchAiAnalysis({ notes, results });
      setAiAnalysis(result);
    } catch (e) {
      console.error("AI Error", e);
    } finally {
      setIsLoading(false);
    }
  };

  const addOrderFromAi = (order) => {
    setOrders([{ id: Date.now(), ...order, status: 'Pending' }, ...orders]);
  };

  return (
    <div className="min-h-screen bg-slate-50 p-4 font-sans text-slate-900">
      {/* Header */}
      <div className="max-w-7xl mx-auto mb-6 flex justify-between items-end">
        <div>
          <h1 className="text-2xl font-black text-slate-800 tracking-tight">ER WORKSTATION <span className="text-blue-600">v2.0</span></h1>
          <p className="text-slate-500 text-sm">Patient: #12345678 - Wang, Da-Ming (65M)</p>
        </div>
        <div className="flex gap-2">
          <div className="bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-bold ring-1 ring-red-200">Triage: 1</div>
          <div className="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold ring-1 ring-blue-200">Bed: ER-A1</div>
        </div>
      </div>

      {/* Main Grid */}
      <div className="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6">
        
        {/* 1. NOTES */}
        <SectionCard 
          title="Notes" 
          icon={FileText} 
          colorClass="bg-blue-50/50"
          action={<button onClick={() => {setEditingNote(null); setNoteModalOpen(true)}} className="p-1 hover:bg-blue-100 rounded text-blue-600"><Plus size={20}/></button>}
        >
          {notes.map(note => (
            <div 
              key={note.id} 
              onClick={() => {setEditingNote(note); setNoteModalOpen(true)}}
              className="group p-3 border rounded-lg hover:border-blue-300 hover:bg-blue-50/30 cursor-pointer transition-all"
            >
              <div className="text-[10px] font-bold text-blue-500 uppercase">{note.date} • {note.type}</div>
              <div className="font-semibold text-slate-700 group-hover:text-blue-700">{note.title}</div>
            </div>
          ))}
        </SectionCard>

        {/* 2. ORDERS */}
        <SectionCard title="Orders" icon={ClipboardList} colorClass="bg-emerald-50/50">
          <div className="flex gap-2 mb-2">
            <input 
              id="quick-order"
              placeholder="Quick Add (e.g. LAB01 CBC)"
              className="flex-1 bg-slate-100 border-none rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-emerald-500 outline-none"
              onKeyDown={(e) => {
                if(e.key === 'Enter') {
                  const [code, ...rest] = e.target.value.split(' ');
                  addOrderFromAi({ code, text: rest.join(' ') });
                  e.target.value = '';
                }
              }}
            />
          </div>
          {orders.map(order => (
            <div key={order.id} className="flex items-center justify-between p-2 border-b border-slate-100 last:border-0">
              <div className="text-sm">
                <span className="font-mono font-bold text-emerald-600 mr-2">{order.code}</span>
                <span className="text-slate-600">{order.text}</span>
              </div>
              <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold ${order.status === 'Done' ? 'bg-slate-100 text-slate-400' : 'bg-emerald-100 text-emerald-700'}`}>
                {order.status}
              </span>
            </div>
          ))}
        </SectionCard>

        {/* 3. RESULTS */}
        <SectionCard title="Results" icon={Activity} colorClass="bg-orange-50/50">
          <div className="grid grid-cols-2 gap-3">
            {results.map((res, i) => (
              <div key={i} className={`p-3 rounded-xl border ${res.normal ? 'bg-white' : 'bg-red-50 border-red-100'}`}>
                <div className="text-xs text-slate-500">{res.label}</div>
                <div className={`text-xl font-black ${res.normal ? 'text-slate-800' : 'text-red-600'}`}>
                  {res.value} <span className="text-xs font-normal opacity-60">{res.unit}</span>
                </div>
              </div>
            ))}
          </div>
        </SectionCard>

        {/* 4. D/D AI ASSISTANT */}
        <SectionCard 
          title="Differential Diagnosis" 
          icon={BrainCircuit} 
          colorClass="bg-purple-50/50"
          action={
            <button 
              onClick={handleRunAi}
              disabled={isLoading}
              className="flex items-center gap-1.5 bg-purple-600 hover:bg-purple-700 disabled:bg-purple-300 text-white px-3 py-1 rounded-lg text-xs font-bold transition-all shadow-sm"
            >
              {isLoading ? <Loader2 size={14} className="animate-spin"/> : <Sparkles size={14}/>}
              AI Analysis
            </button>
          }
        >
          {aiAnalysis ? (
            <div className="space-y-4 animate-in fade-in slide-in-from-bottom-2">
              <div className="space-y-3">
                {aiAnalysis.dd.map((d, i) => (
                  <div key={i} className="bg-white p-3 rounded-lg border border-purple-100 shadow-sm">
                    <div className="flex justify-between items-center mb-1">
                      <span className="font-bold text-slate-800">{d.name}</span>
                      <span className="text-purple-600 font-black">{d.prob}%</span>
                    </div>
                    <div className="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                      <div className="bg-purple-500 h-full transition-all duration-1000" style={{ width: `${d.prob}%` }}></div>
                    </div>
                    <p className="text-[10px] text-slate-500 mt-2 italic">“{d.reason}”</p>
                  </div>
                ))}
              </div>
              <div className="pt-2 border-t border-purple-100">
                <div className="text-[10px] font-bold text-purple-400 uppercase mb-2">Recommended Orders</div>
                <div className="space-y-2">
                  {aiAnalysis.orders.map((o, i) => (
                    <button 
                      key={i}
                      onClick={() => addOrderFromAi(o)}
                      className="w-full flex items-center justify-between p-2 text-left text-xs bg-purple-50 hover:bg-purple-100 text-purple-700 rounded-lg border border-purple-100 transition-colors"
                    >
                      <span><span className="font-bold">{o.code}</span> {o.text}</span>
                      <Plus size={14}/>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          ) : (
            <div className="h-full flex flex-col items-center justify-center text-slate-400 space-y-2">
              <BrainCircuit size={48} strokeWidth={1} className="opacity-20"/>
              <p className="text-xs">點擊「AI Analysis」獲取臨床建議</p>
            </div>
          )}
        </SectionCard>
      </div>

      {/* Note Edit Modal */}
      {isNoteModalOpen && (
        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-in zoom-in-95">
            <div className="p-4 border-b flex justify-between items-center bg-slate-50">
              <h3 className="font-bold">{editingNote ? 'Edit Note' : 'New Note'}</h3>
              <button onClick={() => setNoteModalOpen(false)}><X size={20}/></button>
            </div>
            <div className="p-6 space-y-4">
              <input 
                defaultValue={editingNote?.title} 
                id="modal-title"
                placeholder="Note Title (e.g. Vital Signs Stable)"
                className="w-full text-lg font-bold border-none focus:ring-0 outline-none placeholder:text-slate-300"
              />
              <textarea 
                defaultValue={editingNote?.content}
                id="modal-content"
                rows={10}
                placeholder="Start typing findings..."
                className="w-full text-sm border-none focus:ring-0 outline-none resize-none placeholder:text-slate-300"
              />
              <div className="flex justify-end gap-3 pt-4 border-t">
                <button onClick={() => setNoteModalOpen(false)} className="px-4 py-2 text-sm font-medium text-slate-500">Cancel</button>
                <button 
                  onClick={() => {
                    const title = document.getElementById('modal-title').value;
                    const content = document.getElementById('modal-content').value;
                    if(editingNote) {
                      setNotes(notes.map(n => n.id === editingNote.id ? {...n, title, content} : n));
                    } else {
                      setNotes([{ id: Date.now(), title, content, type: 'Progress Note', date: '12/12' }, ...notes]);
                    }
                    setNoteModalOpen(false);
                  }}
                  className="px-6 py-2 bg-blue-600 text-white rounded-xl text-sm font-bold shadow-md shadow-blue-200"
                >
                  Save Note
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
